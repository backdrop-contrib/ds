<?php
// $Id$

/**
 * @file
 * Search tests
 */

/**
 * Test node entity.
 */
class dsSearchTests extends dsBaseTest {

  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Search'),
      'description' => t('Tests for display of search results for nodes and users.'),
      'group' => t('Display suite'),
    );
  }

  function testDSSearch() {

    // Create nodes.
    $i = 15;
    while ($i > 0) {
      $settings = array(
        'search ' . $i,
        'type' => 'article',
      );
      $this->drupalCreateNode($settings);
      $i--;
    }

    // Set default search.
    $edit = array(
      'search_active_modules[ds_search]' => 'ds_search',
      'search_active_modules[node]' => '',
      'search_default_module' => 'ds_search',
    );
    $this->drupalPost('admin/config/search/settings', $edit, t('Save configuration'));

    // Run cron.
    drupal_cron_run();
    $this->drupalGet('admin/config/search/settings');
    $this->assertText(t('100% of the site has been indexed. There are 0 items left to index.'), 'Site has been indexed');

    // Configure search result view mode.
    $svm = array('display_suite[modes][view_modes_custom][search_result]' => 'search_result');
    $this->dsConfigureUI($svm);
    $layout = array(
      'display_suite[layout]' => 'ds_2col_stacked',
    );
    $assert = array(
      'regions' => array(
        'header' => '<td colspan="8">' . t('Header') . '</td>',
        'left' => '<td colspan="8">' . t('Left') . '</td>',
        'right' => '<td colspan="8">' . t('Right') . '</td>',
        'footer' => '<td colspan="8">' . t('Footer') . '</td>',
      ),
    );
    $this->dsSelectLayout($layout, $assert, 'admin/structure/types/manage/article/display/search_result');
    $fields = array(
      'fields[title][region]' => 'header',
      'fields[post_date][region]' => 'header',
      'fields[author][region]' => 'left',
      'fields[body][region]' => 'right',
      'fields[read_more][region]' => 'footer',
    );
    $this->dsConfigureUI($fields, 'admin/structure/types/manage/article/display/search_result');

    // Configure ds search.
    $this->drupalPost('admin/structure/ds/search', array(), t('Save configuration'));

    // Let's search.
    $this->drupalGet('search/content/search');
    $this->drupalGet('search/content/jow');
  }
}
