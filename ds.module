<?php
// $Id$

/**
 * Core functions for the Display Suite module.
 */


/**
 * Constants for field types.
 */
define('DS_FIELD_TYPE_THEME', 1);
define('DS_FIELD_TYPE_FUNCTION', 2);
define('DS_FIELD_TYPE_PREPROCESS', 3);
define('DS_FIELD_TYPE_IGNORE', 4);
define('DS_FIELD_TYPE_CODE', 5);
define('DS_FIELD_TYPE_BLOCK', 6);

/**
 * Constants for field statuses.
 */
define('DS_FIELD_STATUS_STATIC', 1);
define('DS_FIELD_STATUS_DEFAULT', 2);
define('DS_FIELD_STATUS_CUSTOM', 3);
define('DS_FIELD_STATUS_OVERRIDDEN', 4);

/**
 * API function to get fields.
 *
 * @param $entity_type
 *   The name of the entity.
 * @param $bundle
 *   The name of bundle (ie, page or story for node types, profile for users)
 * @param $view_mode
 *   The name of view mode.
 * @param $reset
 *   Whether we need to reset the fields cache or not.
 * @param $cache
 *   Whether we need to cache the the fields or not.
 * @return
 *   Collection of fields.
 */
function ds_get_fields($entity_type, $bundle, $view_mode, $reset = FALSE, $cache = TRUE) {
  // Let's get node.inc now.
  // TODO other way to register.
  require_once('entities/node.inc');
  $fields = ds_node_fields($entity_type, $bundle, $view_mode);
  return $fields;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function ds_form_field_ui_display_overview_form_alter(&$form, &$form_state) {
  module_load_include('inc', 'ds', 'includes/ds.display');
  ds_extend_manage_display_table($form, $form_state);
}

/**
 * Save the region and field settings from the 'Manage display' screen.
 */
function ds_form_field_ui_display_overview_form_alter_submit($form, &$form_state) {
  module_load_include('inc', 'ds', 'includes/ds.display');
  ds_extend_manage_display_table_submit($form, $form_state);
}

/**
 * Implements hook_field_attach_view_alter().
 */
function ds_field_attach_view_alter(&$output, $context) {
  $entity_type = $output['#entity_type'];
  $bundle = $output['#bundle'];
  ds_render_content($output, $entity_type, $bundle, $context['view_mode']);
}

/**
 * Render content of an entity.
 * TODO A LOT :)
 */
function ds_render_content(&$output, $entity_type, $bundle, $view_mode) {
  $weight = 5;
  $i = 0;
  $fields = ds_get_fields($entity_type, $bundle, $view_mode);
  foreach ($fields as $key => $field) {
    $output[$key] = array(
      '#theme' => 'field',
      '#field_type' => 'ds',
      '#title' => $field['title'],
      '#weight' => $weight++,
      '#label_display' => 'inline',
      '#field_name' => $key,
      '#bundle' => $bundle,
      '#entity_type' => $entity_type,
      '#access' => TRUE,
      '#items' => array(
        0 => array(
          'value' => 'field ' . $i++,
        ),
      ),
      0 => array(
        '#markup' => 'field ' . $i,
      ),
    );
  }
}

